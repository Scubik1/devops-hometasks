name: Course

on: 
  # push:
  workflow_dispatch:

jobs:
  # bump-tag:
  #   runs-on: ubuntu-latest
  #   # permissions:
  #   #   contents: write
  #   steps:

  #   - name: Checkout
  #     uses: actions/checkout@v3.5.3
  #     with:
  #       repository: Scubik1/devops-hometasks
  #       fetch-depth: 0

  #   - name: bump
  #     id: tagbump
  #     uses: anothrNick/github-tag-action@1.67.0
  #     env:
  #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
  #   outputs:
  #     tag: ${{ steps.tagbump.outputs.tag }}
  
  # build:
  #   needs: [bump-tag]
  #   runs-on: ubuntu-latest
  #   steps:
   
  #   - name: Checkout
  #     uses: actions/checkout@v3.5.3
  #     with:
  #       repository: Scubik1/devops-hometasks

  #   - name: Login to GitHub Container Registry
  #     uses: docker/login-action@v2.2.0
  #     with:
  #       registry: ghcr.io
  #       username: ${{ github.actor }}
  #       password: ${{ secrets.GITHUB_TOKEN }}

  #   - name: Lower case owner
  #     run: echo "ghro_lc=$(echo $GITHUB_REPOSITORY_OWNER | tr '[:upper:]' '[:lower:]')" >> ${GITHUB_ENV}

  #   - name: Build and push Docker image
  #     uses: docker/build-push-action@v4.1.1
  #     with:
  #       context: ./07-docker
  #       file: ./07-docker/Dockerfile.multi
  #       push: true
  #       tags: ghcr.io/${{ env.ghro_lc }}/wcg:latest, ghcr.io/${{ env.ghro_lc }}/wcg:${{ needs.bump-tag.outputs.tag }}

  lint-test:
    # needs: [bump-tag, build]
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout
      uses: actions/checkout@v3.5.3
      with:
        fetch-depth: 0
        #repository: Scubik1/devops-hometasks
       # path: '12-helm'

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.1

    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        check-latest: true

    - name: Set up chart-testing
      uses: helm/chart-testing-action@v2.4.0
      # with:
      #   version: 'v3.7.1'
      #   yamale_version: 4.0.4

    - name: Run chart-testing (list-changed)
      id: list-changed
      run: |
        echo "${{ github.event.repository.default_branch }}"
        # ls -lah /home/runner/work/devops-hometasks/devops-hometasks/12-helm
        cat /home/runner/work/devops-hometasks/devops-hometasks/12-helm/Chart.yaml
        cat /home/runner/work/devops-hometasks/devops-hometasks/charts/Chart.yaml
        # ct list-changed --chart-dirs charts/
        # ct lint --chart-dirs charts/
        ct lint --all --validate-maintainers=false --validate-chart-schema=false --validate-yaml=false --target-branch=main --chart-dirs=charts/
        ct lint --validate-maintainers=false --charts=/home/runner/work/devops-hometasks/devops-hometasks/charts/
        #ct lint --remote origin --target-branch main --chart-dirs charts/
        # ct lint --target-branch master
        # ct lint --target-branch ${{ github.event.repository.default_branch }}
        #ct lint --all --chart-dirs charts/ --debug --check-version-increment
        # ct version
        changed=$(ct list-changed --target-branch main) 
        echo "$changed"
        if [[ -n "$changed" ]]; then
          echo "changed=true" >> "$GITHUB_OUTPUT"
        fi

    - name: Run chart-testing (lint)
      if: steps.list-changed.outputs.changed == 'true'
      run: ct lint --target-branch main}

    - name: Create kind cluster
      if: steps.list-changed.outputs.changed == 'true'
      uses: helm/kind-action@v1.7.0

    - name: Run chart-testing (install)
      if: steps.list-changed.outputs.changed == 'true'
      run: ct install --target-branch main

  # chart-releaser:
  #   needs: [bump-tag, build, lint-test]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #   steps:
    
  #   - name: Checkout
  #     uses: actions/checkout@v3
  #     with:
  #       fetch-depth: 0
          
  #   - name: Set up Helm
  #     uses: azure/setup-helm@v3
  #     with:
  #       version: v3.12.1
        
  #   - name: Add chart to repos
  #     run: | 
  #       helm package 12-helm/ --app-version ${{ needs.bump-tag.outputs.tag }} --version ${{ needs.bump-tag.outputs.tag }} -d charts/
  #       helm repo index --url https://Scubik1.github.io/devops-hometasks/ .
  #       git config --global user.email "takogo@adresa.net"
  #       git config --global user.name "My Name"
  #       git add .
  #       git commit -m "Updated Helm package"
  #       git push origin main
